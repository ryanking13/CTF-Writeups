## TW_GR_E4_STW - 200

### Description

Many saw [the fourth installment of Toaster Wars: Going Rogue](http://shell2017.picoctf.com:62529/) as a return to grace after the relative mediocrity of the third. I'm just glad it was made at all. And hey, they added some nifty new [online scoreboard](http://shell2017.picoctf.com:62529/scoreboard) features, too!

### Hint

  - Ooh, what a nifty scoreboard! If we get a bunch of people playing at once, we can have a race through the dungeon!

### Write up

Whenever we go floor 4, the stair is surrounded with walls, so that we can't reach it.

There is a floor generation function call is `server/game.js`

```js
socket.on("action", function(action){
...
    if(state.player.location.r == state.map.stairs.r && state.player.location.c == state.map.stairs.c){
    					db.scoreboard[socket.id].floor++;
    					prm = generator.generateFloor(db.scoreboard[socket.id].floor)
    						.then((newState) => {
    							if(newState.done){
    								socket.emit("win");
    								return Promise.all[db.commit(socket.id, {done: true, win: true}), initState];
    							}

```

So, whenever action happens and the location of the player is same as the location of the stair, floor value increments.

But as Node.js runs asynchronously, we can invoe a race condition.

What we want is to invoke action almost simultaneously, so that increment floor value 2 times at once before the stage actually changes.

Where we gonna fix is here in `client.js`

```js
api("action", {
  type: "move",
  direction: moveDir
});
```

to

```js
api("action", {
  type: "move",
  direction: 6
});
api("action", {
  type: "move",
  direction: 2
});
api("action", {
  type: "move",
  direction: 6
});
```

This makes the character move down-up-down.

At floor3, we go one step above the stair, fix the code, and move.

Then, the floor increments 2. Yes we are on floor 5.

> im_still_upset_you_dont_get_to_keep_the_cute_scarves_in_the_postgame_f319de54224c57fd5523f7f9ee1a6fc6
